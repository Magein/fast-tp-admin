{extend name='admin@base/main'}

{block name="content"}

{include file="admin@public/table"}

{/block}

{block name="script"}
<script type="text/javascript">
    $(function () {

        var table = layui.table;
        var tableId = 'data-list';

        if (renderData.page.per_page === undefined) {
            renderData.page.per_page = 9999;
        }

        layui.use('laypage', function () {

            if (renderData.page.total === undefined) {
                return false;
            }

            layui.laypage.render({
                // 分页容器
                elem: 'page-container',
                layout: ['prev', 'page', 'next', 'count', 'limit'],
                //数据总数，从服务端得到
                count: renderData.page.total,
                // 每页数量
                limit: renderData.page.per_page,
                limits: [
                    15,
                    30,
                    100
                ],
                // 当前页
                curr: renderData.page.current_page,
                prev: '<',
                next: '>',
                jump: function (obj, first) {

                    //首次不执行
                    if (first) {
                        return false;
                    }

                    let href = window.location.href;

                    if (href.indexOf('?') === -1) {
                        href += '?';
                    }

                    if (href.indexOf('&page=') === -1) {
                        href += '&page=' + obj.curr;
                    } else {
                        href = href.replace(/&page=[0-9]+/, '&page=' + obj.curr);
                    }

                    if (href.indexOf('&limit=') === -1) {
                        href += '&limit=' + obj.limit;
                    } else {
                        href = href.replace(/&limit=[0-9]+/, '&limit=' + obj.limit);
                    }

                    window.location.href = href;
                }
            });
        });

        /**
         * 根据数据数量，计算表格的高度
         * @type {Array}
         */
        renderData.list = renderData.list ? renderData.list : [];
        var dataCount = renderData.list.length;
        var height = 0;
        if (dataCount) {
            var offset = 3;
            if (dataCount < 8) {
                offset = 5;
            } else {
                offset = 6;
            }
            height = (dataCount + 2) * 50 + offset;

            if (height > 610) {
                height = 610;
            }
        }

        //执行渲染
        table.render({
            id: tableId,
            //指定原始表格元素选择器
            elem: '#data-list',
            // 分页参数
            page: false,
            limit: renderData.page.per_page,
            //容器高度
            height: height,
            text: {
                none: '暂无相关数据'
            },
            toolbar: '#leftTopButtons',
            defaultToolbar: ['filter'],
            cols: [renderData.header],
            data: renderData.list,
            //开启隔行背景
            even: true,
            //小尺寸的表格
            size: 'lg',
            done: function (res, curr, count) {

            }
        });

        /**
         * 监听工具栏事件
         */
        table.on('toolbar(data-list)', function (obj) {

            if (obj.event === 'LAYTABLE_COLS') {
                return false;
            }

            let data = getData($(this), obj);
            transData(data, function (resp) {
                /**
                 * 这里要注意返回，在回调用处理完成后，后续可以判断一些逻辑
                 */
                return window.reload(resp);
            });
            return false;
        });

        /**
         * 监听操作栏事件
         */
        table.on('tool(data-list)', function (obj) {
            let data = getData($(this), obj);
            transData(data, function (resp) {
                /**
                 * 这里要注意返回，在回调用处理完成后，后续可以判断一些逻辑
                 */
                return window.reload(resp);
            });
            return false;
        });

        /**
         * 监听单元格编辑
         */
        table.on('edit(data-list)', function (obj) {
            let data = {};
            data.type = 'update';
            data.url = updateFieldUrl;
            data.param = {
                id: obj.data.id,
                field: obj.field,
                value: obj.value,
            };
            transData(data);
        });

        /**
         * 获取点击事件可以得到的相关数值
         * @param _this 点击的对象 用于获取额外属性
         * @param obj   layui-table 监听事件返回的参数
         */
        function getData(_this, obj) {
            let data = {};
            let param = _this.data('param');
            let postData = {};
            if (param) {
                for (let i in param) {
                    if ('__' + i + '__' === param[i] && obj.data[i]) {
                        postData[i] = $.trim(obj.data[i]);
                    } else {
                        postData[i] = param[i];
                    }
                }
            }

            data.title = _this.data('title');
            data.type = _this.data('type');
            data.url = _this.data('url');
            data.param = postData;

            return data;
        }

        function transData(data, callback) {
            switch (data.type) {
                case 'modal':
                    $.form.modal(data.url, data.param, data.title);
                    break;
                case 'update':
                    $.form.load(data.url, data.param, 'post', callback);
                    break;
                case 'del':
                    let ids = getSelectedId();
                    console.log(data.param);
                    if (data.param.id && ids) {
                        data.param.id.concat(ids);
                    } else {
                        console.log(ids);
                        data.param.id = ids;
                    }
                    $.form.load(data.url, data.param, 'get', callback);
                    break;
                case 'open':
                    let url = data.url + '?open=1';
                    if (data.param) {
                        url += '&';
                        for (let i in data.param) {
                            url += i + '=' + data.param[i] + '&';
                        }
                        $.trim(url, '&');
                    }
                    window.location.href = url;
                    break;
                default:
                    $.form.load(data.url, data.param, 'post', callback);
            }
            return false;
        }

        /**
         * 获取选中的数据的id
         * @returns {Array}
         */
        function getSelectedId() {
            let all = table.checkStatus(tableId);
            let data = all.data;
            let ids = [];
            if (data) {
                for (let i in data) {
                    ids.push(data[i].id);
                }
            }
            return ids;
        }
    });
</script>
{/block}